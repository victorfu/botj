import { app, BrowserWindow, screen } from "electron";
import appState from "./state";

// This allows TypeScript to pick up the magic constants that's auto-generated by Forge's Webpack
// plugin that tells the Electron app where to look for the Webpack-bundled app code (depending on
// whether you're running in development or production).
declare const MAIN_WINDOW_WEBPACK_ENTRY: string;
declare const MAIN_WINDOW_PRELOAD_WEBPACK_ENTRY: string;

let mainWindow: BrowserWindow;
let imageWindow: BrowserWindow;

export function createWindow(): void {
  mainWindow = new BrowserWindow({
    height: 600,
    width: 800,
    show: false,
    webPreferences: {
      nodeIntegration: false,
      contextIsolation: true,
      preload: MAIN_WINDOW_PRELOAD_WEBPACK_ENTRY,
    },
  });

  mainWindow.webContents.session.webRequest.onHeadersReceived(
    (details, callback) => {
      callback({
        responseHeaders: {
          ...details.responseHeaders,
          "Content-Security-Policy": [
            "default-src 'self' data:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; connect-src 'self' https://firebasestorage.googleapis.com https://*.firebaseio.com https://*.googleapis.com; style-src 'self' 'unsafe-inline';",
          ],
        },
      });
    },
  );

  mainWindow.loadURL(MAIN_WINDOW_WEBPACK_ENTRY);

  if (!app.isPackaged) {
    // mainWindow.webContents.openDevTools();
  }

  mainWindow.on("close", (event) => {
    if (!appState.isQuitting) {
      event.preventDefault();
      mainWindow.hide();
    }
  });
}

export function getMainWindow(): BrowserWindow {
  return mainWindow;
}

export function showMainWindow(): BrowserWindow {
  const mainWindow = getMainWindow();
  if (mainWindow.isVisible()) {
    mainWindow.focus();
  } else {
    mainWindow.show();
  }
  return mainWindow;
}

export function hideMainWindow(): void {
  const mainWindow = getMainWindow();
  mainWindow.hide();
}

export function createImageWindow(dataURL: string) {
  const primaryDisplay = screen.getPrimaryDisplay();
  const { bounds } = primaryDisplay;

  imageWindow = new BrowserWindow({
    width: bounds.width,
    height: bounds.height,
    x: bounds.x,
    y: bounds.y,
    frame: false,
    fullscreen: false,
    autoHideMenuBar: true,
    transparent: true,
    alwaysOnTop: true,
    skipTaskbar: true,
    movable: false,
    resizable: false,
    minimizable: false,
    maximizable: false,
    type: process.platform === "win32" ? "toolbar" : "panel",
    hasShadow: false,
    enableLargerThanScreen: true,
    focusable: false,
    webPreferences: {
      contextIsolation: true,
    },
  });

  imageWindow.setAlwaysOnTop(true, "screen-saver");

  imageWindow.loadURL(
    `data:text/html;charset=utf-8,
    <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Image Display</title>
        <style>
          body {
            margin: 0;
            padding: 0;
          }
          img {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            border: none;
          }
        </style>
      </head>
      <body>
        <img src="${dataURL}" />
      </body>
    </html>`,
  );
}

export function getImageWindow(): BrowserWindow {
  return imageWindow;
}

export function isImageWindowOpen(): boolean {
  return imageWindow && !imageWindow.isDestroyed();
}

export function closeImageWindow() {
  if (imageWindow && !imageWindow.isDestroyed()) {
    imageWindow.close();
  }
}
